---
layout: post
status: publish
published: true
title: Ipgeobase + Nginx
excerpt_separator: ""
author: m-messiah
author_login: m_messiah
author_email: m.muzafarov@gmail.com
author_url: https://m-messiah.ru
date: 2015-08-05 15:50:00 +03:00
categories: python nginx web
tags: []
comments: true
---

Когда возникает задача — по адресу посетителя получать его город и налоговый (автомобильный) код региона, кажется — да это же просто, в инете полно таких штук!
А потом смотришь: одни платные, другие нельзя у себя развернуть, третьи можно, но это ресурсозатратно, четвертые о регионах РФ ничего не знают…
И тут на помощь спешит больной мозг программиста с навязчивой идеей: «Нет у других — сделай сам»

Так возникла идея написать конвертер, который выцепляет данные из ipgeobase.ru и строит map-файл для nginx, для корректного определения кода региона и названия города  по адресу клиента.

Конвертер был успешно [отдан в паблик](https://github.com/m-messiah/ipgeobase_importer), о его разработке написана статья на [Хабр](http://habrahabr.ru/post/264219/) и вроде бы можно забыть, но...

Но появляется еще одна связанная задача - почему бы не фильтровать по адресу клиента клиентов из всеми любимого, но так ненавистного спецслужбами ТОР?
Ведь нормальные пользователи налоговую отчетность сдавать через ТОР не будут, а остальные нам и не нужны.

В итоге конвертер быстро обзавелся дополнительными источниками в виде torstatus.blutmagie.de и check.torproject.org, научился строить дополнительное отображение адреса в 0 или 1, в зависимости от принадлежности к списку ТОР адресов, а nginx получил возможность делать вот так:

```nginx
if ($is_tor) { return 450;}
```
