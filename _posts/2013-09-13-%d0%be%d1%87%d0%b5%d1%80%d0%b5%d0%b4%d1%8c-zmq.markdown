---
layout: post
status: publish
published: true
title: Очередь ZMQ
author: M_Messiah
author_login: Messiah
author_email: m.muzafarov@gmail.com
author_url: http://m.muzafarov.vk.com
excerpt: "Задачка из курса Распределённых Объектных технологий.\r\n<ul>\r\n\t<li>master
  генерирует пары чисел</li>\r\n\t<li>worker складывает числа</li>\r\n\t<li>master
  ---async (pub/sub)--> worker</li>\r\n\t<li>worker ---async (pub/sub)
  --> master</li>\r\n</ul>\r\n"
wordpress_id: 254
wordpress_url: http://messiah.ks8.ru/?p=254
date: 2013-09-13 16:20:58.000000000 +06:00
categories:
- Python
tags: []
comments: []
---
Задачка из курса Распределённых Объектных технологий.
<ul>
	<li>master генерирует пары чисел</li>
	<li>worker складывает числа</li>
	<li>master ---async (pub/sub)--> worker</li>
	<li>worker ---async (pub/sub) --> master</li>
</ul>

## <a href="https://github.com/m-muzafarov/ROT/tree/master/Task6#%D0%97%D0%B0%D0%BF%D1%83%D1%81%D0%BA" name="%D0%97%D0%B0%D0%BF%D1%83%D1%81%D0%BA"></a>Запуск ##
<ul>
	<li>python master.py</li>
	<li>python worker.py</li>
</ul>
## <a href="https://github.com/m-muzafarov/ROT/tree/master/Task6#%D0%9F%D0%BE%D0%B2%D0%B5%D0%B4%D0%B5%D0%BD%D0%B8%D0%B5" name="%D0%9F%D0%BE%D0%B2%D0%B5%D0%B4%D0%B5%D0%BD%D0%B8%D0%B5"></a>Поведение ##
Мастер генерирует пар чисел (REPEATS = 100), выводит на консоль, отправляет их worker'у и слушает ответы.

Worker считает и отправляет ответ по другому каналу.

Master выводит на консоль ответ (выражение = ответ).

В Master.run() есть закомментированная строка возведения в степень, которая более наглядно показывает асинхронность происходящего.

**master.py**
{% highlight python %}#!/usr/bin/python3
# -*- coding: utf-8 -*-
from IN import INT64_MAX, INT64_MIN

__author__ = 'Messiah'

import zmq
import random
REPEATS = 100

class Master():
    def __init__(self, port1, port2):
        self.context = zmq.Context()
        self.output = self.context.socket(zmq.PUB)
        self.output.bind("tcp://127.0.0.1:{}".format(port1))
        self.input = self.context.socket(zmq.SUB)
        self.input.connect("tcp://127.0.0.1:{}".format(port2))
        self.input.setsockopt(zmq.SUBSCRIBE, b"")

    def run(self):
        self.output.send(b"hello")
        for i in range(REPEATS):
            #msg = "{}**{}".format(random.randint(0, INT64_MAX),
            #                     random.randint(10000, 20000))
            msg = "{}+{}".format(random.randint(INT64_MIN, INT64_MAX),
                                 random.randint(INT64_MIN, INT64_MAX))
            self.output.send(msg.encode())
            print(msg)
            for i in range(100000):
                try:
                    msg = self.input.recv(zmq.NOBLOCK).decode()
                except zmq.core.error.ZMQError:
                    pass
                else:
                    print(msg)

        self.output.send(b"exit")
        print("exit")
        while True:
            try:
                msg = self.input.recv(zmq.NOBLOCK).decode()
            except zmq.core.error.ZMQError:
                pass
            else:
                if msg == "exit":
                    return
                print(msg)

if __name__ == "__main__":
    M = Master(5000, 6000)
    M.run(){% endhighlight %}
**worker.py**
{% highlight python %}#!/usr/bin/python3
# -*- coding: utf-8 -*-

__author__ = 'Messiah'

import zmq

class Worker():
    def __init__(self, port1, port2):
        self.context = zmq.Context()
        self.input = self.context.socket(zmq.SUB)
        self.input.connect("tcp://127.0.0.1:{}".format(port1))
        self.input.setsockopt(zmq.SUBSCRIBE, b"")
        self.output = self.context.socket(zmq.PUB)
        self.output.bind("tcp://127.0.0.1:{}".format(port2))
        self.queue = []

    def run(self):
        while True:
            try:
                self.queue.append(self.input.recv(zmq.NOBLOCK).decode())
            except zmq.core.error.ZMQError:
                pass
            if self.queue:
                for msg in self.queue:
                    if msg == "exit":
                        self.output.send(b"exit")
                    else:
                        self.output.send("{} = {}".format(msg,
                                                          eval(msg)).encode())
                    self.queue.remove(msg)

if __name__ == "__main__":
    W = Worker(5000, 6000)
    W.run(){% endhighlight %}

<a href="https://github.com/m-muzafarov/ROT/tree/master/Task6"><img src="http://messiah.ks8.ru/wp-content/uploads/github-button.png" alt="github-button" width="170" height="72" class="alignleft size-full wp-image-258" /></a>
