<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Blocks breaker</title>
        <meta charset="utf-8" />
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" type="text/javascript"></script>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-transcluent" />
        <style>
            * { margin:0; padding:0; }
            html, body { width:100%; height:100%; }
            canvas {display: block;}
            .left {
                left:0;
                bottom:0;
            }
            .right {
                right:0;
                bottom: 0;
            }
            .button {
                border:1px #eee solid;
                display: block;
                position: absolute;
                width:50vw;
                height:20vh;
            }
        </style>
    </head>
    <body>
        <canvas id="canvas"></canvas>
        <area id="left" class="left button"></area>
        <area id="right" class="right button"></area>
        <script>
            $(document).ready(function(){
                //Canvas
                var canvas = document.getElementById('canvas');
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight - $('#left').height();
                var ctx = canvas.getContext("2d");
                var w = canvas.width;
                var h = canvas.height;
                // Cохраняем ширину ячейки в переменную для легкого управления
                var cw = 10;
                var ball;
                var d = "stop";
                var score;
                var lives;
                var pad;
                var blocks;
                var started;


                function init() {
                    pad =  {x:w/2, y:h-40, speed:2, l:cw*10};
                    create_blocks();
                    paint_blocks();
                    //Мяч
                    create_ball();
                    create_lives();
                    //теперь выведем очки
                    score = 0;
                    started = 0;
                    ctx.font = "12pt HelveticaNeue";
                    if(typeof game_loop != "undefined") clearInterval(game_loop);
                    game_loop = setInterval(paint, 1);
                }
                init();

                function create_lives() {
                    lives = [];
                    for (var i=0; i<5; i++) {
                        life = {
                            x: w - i * 3 * ball.r - w/20,
                            y: h - 15,
                        }
                        lives.push(life);
                        ctx.beginPath();
                        ctx.arc(life.x, life.y, ball.r, 0, 2*Math.PI, false);
                        ctx.fillStyle = "#6b0f1a";
                        ctx.fill();
                    }
                }

                function remove_life() {
                    life = lives.shift();
                    ctx.beginPath();
                    ctx.arc(life.x, life.y, ball.r, 0, 2*Math.PI, false);
                    ctx.fillStyle = "#ffffff";
                    ctx.fill();
                    ctx.stroke();
                }

                function create_blocks() {
                    blocks = [];
                    var blocks_length = Math.random() * 200 + 250;
                    for (var i = 0; i < blocks_length; i++) {
                        block = {
                            x: Math.round(Math.random()* 20 * w / 22 + w/20),
                            y: Math.round(Math.random()*h/2),
                        };
                        blocks.push(block);
                    }
                }

                function create_ball() {
                    ball = {
                        x: w/2,
                        y: h-h/3,
                        angle:Math.round(Math.random()*100 + 40),
                        speed: 0,
                        r:7,
                    };
                }

                function paint() {
                    if (started > 0) ball.speed = 1;
                    if (lives.length > 0) {
                        move_pad();
                        paint_pad();
                        move_ball();

                        //Выводим счет
                        var score_text = "Очки: " + score + " Блоков: " + blocks.length;
                        ctx.fillStyle = "#ffffff";
                        ctx.fillRect(1, h-30, 200, 28);
                        ctx.fillStyle = "#6b0f1a";
                        ctx.fillText(score_text, 5, h-5);
                    }
                }

                function paint_blocks() {
                    ctx.fillStyle = "#466995";
                    for (var i = 0; i < blocks.length; i++)
                        ctx.fillRect(blocks[i].x, blocks[i].y, cw, cw);
                }

                function paint_pad() {
                    ctx.fillStyle = "#ffffff";
                    ctx.fillRect(1, pad.y - 5, w - 1, cw + 10);
                    ctx.fillStyle = "#6b0f1a";
                    ctx.fillRect(pad.x, pad.y, pad.l, cw);
                    ctx.strokeStyle = "gray";
                    ctx.strokeRect(pad.x, pad.y, pad.l, cw);
                }

                function move_pad() {
                    if(d == "right") {
                        if (pad.x + pad.l < w - pad.speed)
                            pad.x += pad.speed;
                    } else if(d == "left") {
                        if (pad.x > pad.speed)
                            pad.x -= pad.speed;
                    }
                }

                function move_ball() {
                    if (ball.x > w - ball.r || ball.x < ball.r)
                        ball.angle = 180 - ball.angle;
                    if (ball.y > h - ball.r || ball.y < ball.r)
                        ball.angle = 360 - ball.angle;

                    if (ball.y > pad.y) {
                        if (ball.x > pad.x - ball.r && ball.x < pad.x + pad.l + ball.r)
                            if ((ball.x < pad.x + pad.l / 3 && ball.x + Math.cos(ball.angle * Math.PI / 180) * ball.speed > ball.x) ||
                                (ball.x > pad.x + 2/3*pad.l && ball.x + Math.cos(ball.angle * Math.PI / 180) * ball.speed < ball.x))
                                ball.angle = ball.angle - 180;
                            else
                                ball.angle = 360 - ball.angle;
                        else {
                            console.log(lives.length);
                            remove_life();
                            clear_ball();
                            create_ball();
                            started = 0
                            if (lives.length < 1)
                                alert("Игра окончена. Ваш счет: " + score);
                            return;
                        }
                    }
                    for (var i=0; i< blocks.length; i++) {
                        if (ball.x > blocks[i].x - ball.r && ball.x < blocks[i].x + cw + ball.r && ball.y > blocks[i].y - ball.r && ball.y < blocks[i].y + cw + ball.r) {
                            if (ball.y > blocks[i].y + cw || ball.y < blocks[i].y)
                                ball.angle = 360 - ball.angle;
                            else
                                ball.angle = 180 - ball.angle;
                            score += 1
                            ctx.fillStyle = "#ffffff";
                            ctx.fillRect(blocks[i].x, blocks[i].y, cw, cw);
                            blocks.splice(i, 1);
                            if (blocks.length < 1) {
                                alert("Победа! Ваш счет: " + score + ", Осталось жизней: " + lives);
                                started = 0;
                                return;
                            }
                            break;
                        }
                    }
                    clear_ball();
                    ball.x += Math.cos(ball.angle * Math.PI / 180) * ball.speed;
                    ball.y += Math.sin(ball.angle * Math.PI / 180) * ball.speed;
                    paint_ball();
                }

                function clear_ball() {
                    ctx.beginPath();
                    ctx.arc(ball.x, ball.y, ball.r + 1, 0, 2*Math.PI, false);
                    ctx.fillStyle = "#ffffff";
                    ctx.fill();
                }
                function paint_ball() {
                    ctx.beginPath();
                    ctx.arc(ball.x, ball.y, ball.r, 0, 2*Math.PI, false);
                    ctx.fillStyle = "#797D81";
                    ctx.fill();
                }

                function handleKeys(e){
                    var key = e.which;
                    if (started == 0) started = 1;
                    if(key == "37") d = "left";
                    else if(key == "39") d = "right";

                }
                $("#left").on('touchstart', function(e){e.which = 37; handleKeys(e);});
                $("#right").on('touchstart', function(e){e.which = 39; handleKeys(e);});
                $("#left").mousedown(function(e){e.which = 37; handleKeys(e);})
                $("#right").mousedown(function(e){e.which = 39; handleKeys(e);})


                $("#right").on('touchleave', function(e){d = "stop";});
                $("#left").on('touchleave', function(e){d = "stop";});
                $(document).on('touchend', function(e){d = "stop";});
                $(document).on('touchcancel', function(e){d = "stop";});
                $(document).mouseup(function(e){d = "stop";})
                $(document).keydown(function(e){handleKeys(e);});
                $(document).keyup(function(e){d = "stop";});

            })
        </script
    </body>
</html>
